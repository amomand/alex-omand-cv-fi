name: Generate CV PDF

on:
  push:
    branches: ["main"]
    paths:
      - "docs/index.md"
      - "docs/style.css"
      - ".github/workflows/generate-cv-pdf.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  pdf:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm init -y
          npm i -D marked playwright
          npx playwright install --with-deps chromium

      - name: Build PDF
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const path = require("path");
          const { chromium } = require("playwright");
          const { marked } = require("marked");

          const markdownPath = path.resolve("docs/index.md");
          const cssPath = path.resolve("docs/style.css");
          const outputPdf = path.resolve("docs/Alex-Omand-CV.pdf");
          const outputHtml = path.resolve(".pdf-build/index.html");

          const markdown = fs.readFileSync(markdownPath, "utf8");
          const css = fs.readFileSync(cssPath, "utf8");

          const cleanedMarkdown = markdown
            .split("\n")
            .filter((line) => !line.startsWith("<link rel=\"stylesheet\""))
            .join("\n");

          const html = `<!doctype html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
              <style>${css}</style>
            </head>
            <body class="markdown-body pdf-output">
              ${marked.parse(cleanedMarkdown)}
            </body>
          </html>`;

          fs.mkdirSync(path.dirname(outputHtml), { recursive: true });
          fs.writeFileSync(outputHtml, html);

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            const url = "file://" + outputHtml;
            await page.goto(url, { waitUntil: "networkidle" });
            await page.pdf({
              path: outputPdf,
              format: "A4",
              printBackground: true,
              margin: { top: "12mm", right: "12mm", bottom: "12mm", left: "12mm" }
            });
            await browser.close();
          })().catch((err) => {
            console.error(err);
            process.exit(1);
          });
          NODE

      - name: Commit PDF
        run: |
          if [ ! -f docs/Alex-Omand-CV.pdf ]; then
            echo "PDF not found at docs/Alex-Omand-CV.pdf"
            exit 1
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/Alex-Omand-CV.pdf
          if git diff --cached --quiet; then
            echo "No PDF changes to commit."
            exit 0
          fi
          git commit -m "Update CV PDF"
          git push
